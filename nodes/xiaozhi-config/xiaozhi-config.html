<script type="text/javascript">
  RED.nodes.registerType('xiaozhi-config', {
    category: 'config',
    defaults: {
      name: { value: '', required: true },
      endpoint: { 
        value: 'wss://api.xiaozhi.me/mcp/', 
        required: true,
        validate: function(v) {
          return v && (v.startsWith('ws://') || v.startsWith('wss://'));
        }
      },
      serverName: { value: 'Thiết bị NodeRED', required: true },
      autoReconnect: { value: true },
      reconnectDelay: { 
        value: 5000, 
        required: true,
        validate: function(v) {
          const num = parseInt(v);
          return !isNaN(num) && num >= 1000 && num <= 300000;
        }
      },
      heartbeatInterval: { 
        value: 30000, 
        required: true,
        validate: function(v) {
          const num = parseInt(v);
          return !isNaN(num) && num >= 10000 && num <= 600000;
        }
      },
      requestTimeout: {
        value: 30000,
        required: true,
        validate: function(v) {
          const num = parseInt(v);
          return !isNaN(num) && num >= 5000 && num <= 120000;
        }
      }
    },
    credentials: {
      token: { type: 'password', required: true }
    },
    label: function() {
      return this.name || 'Kết nối MCP Xiaozhi';
    },
    oneditprepare: function() {
      const node = this;
      
      // Thiết lập xác thực và gợi ý cho biểu mẫu
      $('#node-config-input-endpoint').on('input change', function() {
        const value = $(this).val();
        const isValid = value && (value.startsWith('ws://') || value.startsWith('wss://'));
        
        if (!isValid && value) {
          $(this).addClass('input-error');
          $('#endpoint-error').text('Vui lòng nhập địa chỉ WebSocket hợp lệ (ws:// hoặc wss://)').show();
        } else {
          $(this).removeClass('input-error');
          $('#endpoint-error').hide();
        }
      });

      // Xác thực đầu vào số
      $('#node-config-input-reconnectDelay').on('input change', function() {
        const value = parseInt($(this).val());
        if (isNaN(value) || value < 1000 || value > 300000) {
          $(this).addClass('input-error');
          $('#reconnect-delay-error').text('Độ trễ kết nối lại phải nằm trong khoảng 1000-300000ms').show();
        } else {
          $(this).removeClass('input-error');
          $('#reconnect-delay-error').hide();
        }
      });

      $('#node-config-input-heartbeatInterval').on('input change', function() {
        const value = parseInt($(this).val());
        if (isNaN(value) || value < 10000 || value > 600000) {
          $(this).addClass('input-error');
          $('#heartbeat-interval-error').text('Khoảng thời gian nhịp tim phải nằm trong khoảng 10000-600000ms').show();
        } else {
          $(this).removeClass('input-error');
          $('#heartbeat-interval-error').hide();
        }
      });

      $('#node-config-input-requestTimeout').on('input change', function() {
        const value = parseInt($(this).val());
        if (isNaN(value) || value < 5000 || value > 120000) {
          $(this).addClass('input-error');
          $('#request-timeout-error').text('Thời gian chờ yêu cầu phải nằm trong khoảng 5000-120000ms').show();
        } else {
          $(this).removeClass('input-error');
          $('#request-timeout-error').hide();
        }
      });

      // Nút kiểm tra kết nối
      $('#test-connection-btn').on('click', function() {
        const btn = $(this);
        const originalText = btn.text();
        
        // Vô hiệu hóa nút và hiển thị trạng thái đang tải
        btn.prop('disabled', true).text('Đang kiểm tra...');
        $('#test-result').hide();

        // Gửi yêu cầu kiểm tra
        $.ajax({
          url: `xiaozhi-config/${node.id}/test`,
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({
            endpoint: $('#node-config-input-endpoint').val(),
            token: $('#node-config-input-token').val(),
            serverName: $('#node-config-input-serverName').val()
          }),
          success: function(data) {
            if (data.success) {
              $('#test-result')
                .removeClass('test-error')
                .addClass('test-success')
                .html('<i class="fa fa-check"></i> Kiểm tra kết nối thành công')
                .show();
            } else {
              $('#test-result')
                .removeClass('test-success')
                .addClass('test-error')
                .html('<i class="fa fa-times"></i> Kết nối thất bại: ' + (data.error || 'Lỗi không xác định'))
                .show();
            }
          },
          error: function(xhr) {
            let errorMsg = 'Kiểm tra thất bại';
            try {
              const response = JSON.parse(xhr.responseText);
              errorMsg = response.error || errorMsg;
            } catch (e) {
              errorMsg = xhr.statusText || errorMsg;
            }
            
            $('#test-result')
              .removeClass('test-success')
              .addClass('test-error')
              .html('<i class="fa fa-times"></i> ' + errorMsg)
              .show();
          },
          complete: function() {
            // Khôi phục trạng thái nút
            btn.prop('disabled', false).text(originalText);
          }
        });
      });

      // Mở rộng/Thu gọn cài đặt nâng cao
      $('#advanced-toggle').on('click', function() {
        $('#advanced-settings').toggle();
        const icon = $(this).find('i');
        if (icon.hasClass('fa-chevron-down')) {
          icon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
        } else {
          icon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
        }
      });

      // Khởi tạo trạng thái cài đặt nâng cao
      $('#advanced-settings').hide();
    },

    oneditsave: function() {
      // Xác thực tất cả các trường bắt buộc
      let isValid = true;
      
      if (!$('#node-config-input-name').val().trim()) {
        isValid = false;
      }
      
      if (!$('#node-config-input-endpoint').val().trim()) {
        isValid = false;
      }
      
      if (!$('#node-config-input-token').val().trim()) {
        isValid = false;
      }

      return isValid;
    }
  });
</script>

<script type="text/html" data-template-name="xiaozhi-config">
  <div class="form-row">
    <label for="node-config-input-name"><i class="fa fa-tag"></i> Tên kết nối</label>
    <input type="text" id="node-config-input-name" placeholder="Nhập tên kết nối, ví dụ: Kết nối Xiaozhi 1">
  </div>

  <div class="form-row">
    <label for="node-config-input-endpoint"><i class="fa fa-globe"></i> Địa chỉ máy chủ</label>
    <input type="text" id="node-config-input-endpoint" placeholder="wss://api.xiaozhi.me/mcp/">
    <div id="endpoint-error" class="form-tips" style="color: red; display: none;"></div>
    <div class="form-tips">
      <strong>Gợi ý:</strong> Nhập địa chỉ máy chủ MCP của Xiaozhi, hỗ trợ giao thức ws:// và wss://
    </div>
  </div>

  <div class="form-row">
    <label for="node-config-input-token"><i class="fa fa-key"></i> Mã truy cập</label>
    <input type="password" id="node-config-input-token" placeholder="Nhập mã truy cập">
    <div class="form-tips">
      <strong>Gợi ý:</strong> Mã truy cập được lấy từ nền tảng Xiaozhi, dùng để xác thực
    </div>
  </div>

  <div class="form-row">
    <label for="node-config-input-serverName"><i class="fa fa-server"></i> Tên thiết bị</label>
    <input type="text" id="node-config-input-serverName" placeholder="Thiết bị NodeRED">
    <div class="form-tips">
      <strong>Gợi ý:</strong> Tên thiết bị hiển thị trên nền tảng Xiaozhi
    </div>
  </div>

  <div class="form-row">
    <input type="checkbox" id="node-config-input-autoReconnect" style="width: 20px; margin-right: 5px;">
    <label for="node-config-input-autoReconnect" style="width: auto;">Bật kết nối lại tự động</label>
    <div class="form-tips">
      <strong>Gợi ý:</strong> Tự động thử kết nối lại khi mạng bị ngắt
    </div>
  </div>

  <!-- Cài đặt nâng cao -->
  <div class="form-row">
    <label style="width: auto; cursor: pointer;" id="advanced-toggle">
      <i class="fa fa-chevron-down"></i> Cài đặt nâng cao
    </label>
  </div>

  <div id="advanced-settings">
    <div class="form-row">
      <label for="node-config-input-reconnectDelay"><i class="fa fa-clock-o"></i> Độ trễ kết nối lại (mili giây)</label>
      <input type="number" id="node-config-input-reconnectDelay" min="1000" max="300000" step="1000">
      <div id="reconnect-delay-error" class="form-tips" style="color: red; display: none;"></div>
      <div class="form-tips">
        <strong>Phạm vi:</strong> 1000-300000 mili giây, đề xuất 5000 mili giây
      </div>
    </div>

    <div class="form-row">
      <label for="node-config-input-heartbeatInterval"><i class="fa fa-heartbeat"></i> Khoảng thời gian nhịp tim (mili giây)</label>
      <input type="number" id="node-config-input-heartbeatInterval" min="10000" max="600000" step="5000">
      <div id="heartbeat-interval-error" class="form-tips" style="color: red; display: none;"></div>
      <div class="form-tips">
        <strong>Phạm vi:</strong> 10000-600000 mili giây, đề xuất 30000 mili giây
      </div>
    </div>

    <div class="form-row">
      <label for="node-config-input-requestTimeout"><i class="fa fa-hourglass-half"></i> Thời gian chờ yêu cầu (mili giây)</label>
      <input type="number" id="node-config-input-requestTimeout" min="5000" max="120000" step="5000">
      <div id="request-timeout-error" class="form-tips" style="color: red; display: none;"></div>
      <div class="form-tips">
        <strong>Phạm vi:</strong> 5000-120000 mili giây, đề xuất 30000 mili giây
      </div>
    </div>
  </div>

  <!-- Kiểm tra kết nối -->
  <div class="form-row">
    <label></label>
    <button type="button" id="test-connection-btn" class="red-ui-button">
      <i class="fa fa-plug"></i> Kiểm tra kết nối
    </button>
    <div id="test-result" style="margin-top: 10px; padding: 10px; border-radius: 3px; display: none;"></div>
  </div>
</script>

<script type="text/html" data-help-name="xiaozhi-config">
  <p>Cấu hình các tham số kết nối với máy chủ MCP Xiaozhi.</p>

  <h3>Mô tả cấu hình</h3>
  <dl class="message-properties">
    <dt>Tên kết nối</dt>
    <dd>Tên được sử dụng để xác định cấu hình kết nối này, nên sử dụng tên có ý nghĩa</dd>

    <dt>Địa chỉ máy chủ</dt>
    <dd>Địa chỉ WebSocket của máy chủ MCP Xiaozhi, hỗ trợ giao thức ws:// và wss://. Thông thường là: wss://api.xiaozhi.me/mcp/</dd>

    <dt>Mã truy cập</dt>
    <dd>Mã truy cập được lấy từ nền tảng Xiaozhi, dùng để xác thực. Vui lòng bảo quản mã này cẩn thận</dd>

    <dt>Tên thiết bị</dt>
    <dd>Tên thiết bị hiển thị trên nền tảng Xiaozhi, giúp nhận diện thiết bị</dd>

    <dt>Kết nối lại tự động</dt>
    <dd>Khi được bật, sẽ tự động thử kết nối lại khi mạng bị ngắt</dd>
  </dl>

  <h3>Cài đặt nâng cao</h3>
  <dl class="message-properties">
    <dt>Độ trễ kết nối lại</dt>
    <dd>Thời gian trễ kết nối lại tự động (mili giây), đề xuất đặt là 5000 mili giây</dd>

    <dt>Khoảng thời gian nhịp tim</dt>
    <dd>Khoảng thời gian gửi tin nhắn nhịp tim (mili giây), dùng để duy trì kết nối hoạt động, đề xuất 30000 mili giây</dd>

    <dt>Thời gian chờ yêu cầu</dt>
    <dd>Thời gian chờ phản hồi từ máy chủ (mili giây), đề xuất 30000 mili giây</dd>
  </dl>

  <h3>Các bước sử dụng</h3>
  <ol>
    <li>Điền tên kết nối, ví dụ "Kết nối Xiaozhi 1"</li>
    <li>Nhập địa chỉ máy chủ MCP của Xiaozhi</li>
    <li>Nhập mã truy cập lấy từ nền tảng Xiaozhi</li>
    <li>Đặt tên thiết bị (tùy chọn)</li>
    <li>Điều chỉnh cài đặt nâng cao nếu cần</li>
    <li>Nhấp vào "Kiểm tra kết nối" để xác minh cấu hình có chính xác không</li>
    <li>Lưu cấu hình</li>
  </ol>

  <h3>Khắc phục sự cố</h3>
  <ul>
    <li><strong>Kết nối thất bại</strong>: Kiểm tra địa chỉ máy chủ và kết nối mạng</li>
    <li><strong>Xác thực thất bại</strong>: Xác nhận mã truy cập có chính xác và chưa hết hạn không</li>
    <li><strong>Ngắt kết nối thường xuyên</strong>: Điều chỉnh khoảng thời gian nhịp tim và độ trễ kết nối lại</li>
  </ul>
</script>

<style>
  .test-success {
    background-color: #dff0d8;
    border: 1px solid #d6e9c6;
    color: #3c763d;
  }
  
  .test-error {
    background-color: #f2dede;
    border: 1px solid #ebccd1;
    color: #a94442;
  }
  
  .input-error {
    border-color: #a94442 !important;
    box-shadow: inset 0 1px 1px rgba(0,0,0,.075), 0 0 6px #ce8483 !important;
  }
  
  .form-tips {
    font-size: 12px;
    color: #666;
    margin-top: 5px;
  }
  
  #advanced-toggle {
    font-weight: bold;
    color: #337ab7;
  }
  
  #advanced-toggle:hover {
    color: #23527c;
  }
  
  #advanced-settings {
    background-color: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 15px;
    margin-top: 10px;
  }
</style>