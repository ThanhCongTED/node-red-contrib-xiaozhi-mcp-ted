<!--
xiaozhi-status Trạng thái giám sát nút
Dùng để giám sát trạng thái kết nối MCP, trạng thái công cụ và tình trạng sức khỏe hệ thống
-->

<script type="text/javascript">
  RED.nodes.registerType('xiaozhi-status', {
    category: 'Xiaozhi MCP',
    color: '#FFE4B5',
    defaults: {
      name: { value: '' },
      xiaozhi: { value: '', type: 'xiaozhi-config', required: true },
      monitorMode: { value: 'auto' },
      outputMode: { value: 'full' },
      pollingInterval: { value: 10000, validate: RED.validators.number() },
      includeStats: { value: true },
      includeHealth: { value: true },
      includeTools: { value: true },
      autoStart: { value: true }
    },
    inputs: 1,
    outputs: 1,
    inputLabels: 'Lệnh điều khiển',
    outputLabels: 'Thông tin trạng thái',
    icon: 'font-awesome/fa-heartbeat',
    label: function() {
      return this.name || 'Giám sát trạng thái';
    },
    labelStyle: function() {
      return this.name ? 'node_label_italic' : '';
    },
    paletteLabel: 'Giám sát trạng thái',
    oneditprepare: function() {
      var node = this;
      
      // Xử lý thay đổi chế độ giám sát
      $('#node-input-monitorMode').on('change', function() {
        var mode = $(this).val();
        var intervalContainer = $('#polling-interval-container');
        var modeHelp = $('#monitor-mode-help');
        
        var helpTexts = {
          'auto': 'Giám sát tự động: Bắt đầu giám sát khi khởi động, kiểm tra trạng thái thay đổi định kỳ',
          'manual': 'Giám sát thủ công: Chỉ kiểm tra trạng thái khi có thông điệp đầu vào kích hoạt',
          'scheduled': 'Giám sát theo lịch: Xuất thông tin trạng thái định kỳ theo khoảng thời gian chỉ định'
        };
        
        modeHelp.text(helpTexts[mode] || '');
        
        if (mode === 'auto' || mode === 'scheduled') {
          intervalContainer.show();
        } else {
          intervalContainer.hide();
        }
      });

      // Xử lý thay đổi chế độ xuất
      $('#node-input-outputMode').on('change', function() {
        var mode = $(this).val();
        var helpTexts = {
          'full': 'Xuất thông tin trạng thái đầy đủ, bao gồm tất cả các mục giám sát được cấu hình',
          'changes': 'Chỉ xuất khi trạng thái thay đổi, bao gồm chi tiết thay đổi',
          'summary': 'Xuất thông tin tóm tắt trạng thái đơn giản'
        };
        $('#output-mode-help').text(helpTexts[mode] || '');
      });

      // Chuyển đổi đơn vị khoảng thời gian kiểm tra
      $('#polling-unit').on('change', function() {
        var unit = $(this).val();
        var intervalField = $('#node-input-pollingInterval');
        var currentValue = parseInt(intervalField.val()) || 10000;
        
        switch(unit) {
          case 'seconds':
            intervalField.val(Math.round(currentValue / 1000));
            break;
          case 'minutes':
            intervalField.val(Math.round(currentValue / 60000));
            break;
          default: // milliseconds
            // Giữ nguyên giá trị
            break;
        }
      });

      // Xem trạng thái thời gian thực
      var statusDisplay = $('#status-display');
      var refreshStatusBtn = $('#refresh-status');
      var monitoringStats = $('#monitoring-stats');

      var updateStatusDisplay = function() {
        if (!node.id) {
          statusDisplay.html('<p class="status-item">Vui lòng lưu cấu hình nút trước</p>');
          return;
        }

        refreshStatusBtn.prop('disabled', true).text('Đang lấy...');

        $.ajax({
          url: 'xiaozhi-status/' + node.id + '/status',
          method: 'GET',
          success: function(data) {
            var html = '<div class="status-container">';
            
            // Trạng thái kết nối MCP
            html += '<div class="status-section">';
            html += '<h4><i class="fa fa-plug"></i> Kết nối MCP</h4>';
            html += '<div class="status-item">Trạng thái: <span class="status-value ' + 
                   (data.mcp.connected ? 'connected' : 'disconnected') + '">' +
                   (data.mcp.connected ? 'Đã kết nối' : 'Chưa kết nối') + '</span></div>';
            html += '<div class="status-item">Điểm cuối: <span class="status-value">' + 
                   (data.mcp.endpoint || 'Chưa cấu hình') + '</span></div>';
            if (data.mcp.lastError) {
              html += '<div class="status-item">Lỗi: <span class="status-value error">' + 
                     data.mcp.lastError + '</span></div>';
            }
            html += '</div>';

            // Thông tin công cụ
            if (data.tools) {
              html += '<div class="status-section">';
              html += '<h4><i class="fa fa-cogs"></i> Công cụ đã đăng ký</h4>';
              html += '<div class="status-item">Số lượng: <span class="status-value">' + 
                     data.tools.count + '</span></div>';
              if (data.tools.names && data.tools.names.length > 0) {
                html += '<div class="status-item">Danh sách công cụ:</div>';
                html += '<ul class="tool-list">';
                data.tools.names.forEach(function(name) {
                  html += '<li>' + name + '</li>';
                });
                html += '</ul>';
              }
              html += '</div>';
            }

            // Trạng thái sức khỏe
            if (data.mcp.health) {
              html += '<div class="status-section">';
              html += '<h4><i class="fa fa-heartbeat"></i> Trạng thái sức khỏe</h4>';
              html += '<div class="status-item">Trạng thái: <span class="status-value ' + 
                     data.mcp.health.status + '">' + data.mcp.health.status + '</span></div>';
              if (data.mcp.health.reason) {
                html += '<div class="status-item">Lý do: <span class="status-value">' + 
                       data.mcp.health.reason + '</span></div>';
              }
              html += '</div>';
            }

            html += '</div>';
            statusDisplay.html(html);
          },
          error: function() {
            statusDisplay.html('<p class="status-item error">Không thể lấy thông tin trạng thái</p>');
          },
          complete: function() {
            refreshStatusBtn.prop('disabled', false).text('Làm mới trạng thái');
          }
        });
      };

      var updateMonitoringStats = function() {
        if (!node.id) return;

        $.ajax({
          url: 'xiaozhi-status/' + node.id + '/stats',
          method: 'GET',
          success: function(data) {
            var html = '<div class="stats-container">';
            html += '<div class="stats-item">Trạng thái giám sát: <span class="' + 
                   (data.monitoring ? 'monitoring' : 'stopped') + '">' +
                   (data.monitoring ? 'Đang giám sát' : 'Đã dừng') + '</span></div>';
            html += '<div class="stats-item">Khoảng thời gian kiểm tra: ' + data.pollingInterval + 'ms</div>';
            html += '<div class="stats-item">Tổng số lần xuất: ' + data.totalOutputs + ' lần</div>';
            html += '<div class="stats-item">Thay đổi trạng thái: ' + data.statusChanges + ' lần</div>';
            html += '<div class="stats-item">Thay đổi kết nối: ' + data.connectionChanges + ' lần</div>';
            if (data.startedAt) {
              html += '<div class="stats-item">Thời gian chạy: ' + 
                     Math.round(data.uptime / 1000) + ' giây</div>';
            }
            html += '</div>';
            monitoringStats.html(html);
          },
          error: function() {
            monitoringStats.html('<p class="error">Không thể lấy thông tin thống kê</p>');
          }
        });
      };

      // Sự kiện nút làm mới
      refreshStatusBtn.on('click', function() {
        updateStatusDisplay();
        updateMonitoringStats();
      });

      // Nút điều khiển giám sát
      $('#start-monitoring').on('click', function() {
        if (!node.id) {
          RED.notify('Vui lòng lưu cấu hình nút trước', 'warn');
          return;
        }

        var button = $(this);
        button.prop('disabled', true);

        $.ajax({
          url: 'xiaozhi-status/' + node.id + '/control',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ action: 'start' }),
          success: function(data) {
            RED.notify('Đã bắt đầu giám sát', 'success');
            updateMonitoringStats();
          },
          error: function() {
            RED.notify('Không thể bắt đầu giám sát', 'error');
          },
          complete: function() {
            button.prop('disabled', false);
          }
        });
      });

      $('#stop-monitoring').on('click', function() {
        if (!node.id) {
          RED.notify('Vui lòng lưu cấu hình nút trước', 'warn');
          return;
        }

        var button = $(this);
        button.prop('disabled', true);

        $.ajax({
          url: 'xiaozhi-status/' + node.id + '/control',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ action: 'stop' }),
          success: function(data) {
            RED.notify('Đã dừng giám sát', 'success');
            updateMonitoringStats();
          },
          error: function() {
            RED.notify('Không thể dừng giám sát', 'error');
          },
          complete: function() {
            button.prop('disabled', false);
          }
        });
      });

      // Nút xem lịch sử
      $('#view-history').on('click', function() {
        if (!node.id) {
          RED.notify('Vui lòng lưu cấu hình nút trước', 'warn');
          return;
        }

        $.ajax({
          url: 'xiaozhi-status/' + node.id + '/history?limit=10',
          method: 'GET',
          success: function(data) {
            var historyText = 'Lịch sử trạng thái gần đây (10 mục):\n\n';
            data.forEach(function(item, index) {
              historyText += (index + 1) + '. ' + new Date(item.timestamp).toLocaleString();
              if (item.changes && item.changes.length > 0) {
                historyText += ' - Thay đổi: ' + item.changes.join(', ');
              }
              historyText += '\n';
            });
            RED.notify(historyText, 'success');
          },
          error: function() {
            RED.notify('Không thể lấy lịch sử', 'error');
          }
        });
      });

      // Chuyển đổi thông tin trợ giúp
      $('.help-toggle').on('click', function() {
        var target = $(this).data('target');
        $(target).toggle();
      });

      // Khởi tạo
      setTimeout(function() {
        $('#node-input-monitorMode').trigger('change');
        $('#node-input-outputMode').trigger('change');
        updateStatusDisplay();
        updateMonitoringStats();
      }, 100);
    },
    oneditsave: function() {
      // Chuyển đổi đơn vị khoảng thời gian kiểm tra
      var unit = $('#polling-unit').val();
      var interval = parseInt($('#node-input-pollingInterval').val()) || 10;
      
      switch(unit) {
        case 'seconds':
          this.pollingInterval = interval * 1000;
          break;
        case 'minutes':
          this.pollingInterval = interval * 60000;
          break;
        default: // milliseconds
          this.pollingInterval = interval;
          break;
      }
    }
  });
</script>

<script type="text/html" data-template-name="xiaozhi-status">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Tên nút</label>
    <input type="text" id="node-input-name" placeholder="Tên nút tùy chọn">
  </div>

  <div class="form-row">
    <label for="node-input-xiaozhi"><i class="fa fa-plug"></i> Cấu hình Xiaozhi</label>
    <input type="text" id="node-input-xiaozhi">
  </div>

  <hr>

  <div class="form-row">
    <label for="node-input-monitorMode"><i class="fa fa-eye"></i> Chế độ giám sát</label>
    <select id="node-input-monitorMode">
      <option value="auto">Giám sát tự động</option>
      <option value="manual">Giám sát thủ công</option>
      <option value="scheduled">Giám sát theo lịch</option>
    </select>
    <div class="red-ui-help">
      <p id="monitor-mode-help">Giám sát tự động: Bắt đầu giám sát khi khởi động, kiểm tra trạng thái thay đổi định kỳ</p>
    </div>
  </div>

  <div id="polling-interval-container" class="form-row">
    <label for="node-input-pollingInterval"><i class="fa fa-clock-o"></i> Khoảng thời gian kiểm tra</label>
    <input type="number" id="node-input-pollingInterval" style="width: 60px;" min="1" step="1" value="10">
    <select id="polling-unit" style="width: 80px; margin-left: 5px;">
      <option value="milliseconds">Miligiây</option>
      <option value="seconds" selected>Giây</option>
      <option value="minutes">Phút</option>
    </select>
  </div>

  <div class="form-row">
    <label for="node-input-outputMode"><i class="fa fa-share"></i> Chế độ xuất</label>
    <select id="node-input-outputMode">
      <option value="full">Thông tin đầy đủ</option>
      <option value="changes">Chỉ thay đổi</option>
      <option value="summary">Tóm tắt ngắn gọn</option>
    </select>
    <div class="red-ui-help">
      <p id="output-mode-help">Xuất thông tin trạng thái đầy đủ, bao gồm tất cả các mục giám sát được cấu hình</p>
    </div>
  </div>

  <hr>

  <div class="form-row">
    <label>Mục giám sát</label>
    <div style="margin-left: 105px;">
      <label style="width: auto;">
        <input type="checkbox" id="node-input-includeStats" style="width: auto; margin-right: 5px;">
        Bao gồm thông tin thống kê
      </label><br>
      <label style="width: auto;">
        <input type="checkbox" id="node-input-includeHealth" style="width: auto; margin-right: 5px;">
        Bao gồm trạng thái sức khỏe
      </label><br>
      <label style="width: auto;">
        <input type="checkbox" id="node-input-includeTools" style="width: auto; margin-right: 5px;">
        Bao gồm thông tin công cụ
      </label>
    </div>
  </div>

  <div class="form-row">
    <label>&nbsp;</label>
    <input type="checkbox" id="node-input-autoStart" style="display:inline-block; width:auto; vertical-align:top;">
    <label for="node-input-autoStart" style="width:70%;">Tự động bắt đầu giám sát khi khởi động</label>
  </div>

  <hr>

  <div class="form-row">
    <label>Trạng thái thời gian thực</label>
    <button type="button" id="refresh-status" class="red-ui-button" style="margin-left: 10px;">
      <i class="fa fa-refresh"></i> Làm mới trạng thái
    </button>
    <button type="button" class="help-toggle red-ui-button" data-target="#commands-help" style="margin-left: 5px;">
      <i class="fa fa-question-circle"></i> Lệnh điều khiển
    </button>
  </div>

  <div id="status-display" class="status-display">
    <p class="status-item">Nhấn nút làm mới trạng thái để lấy thông tin thời gian thực</p>
  </div>

  <div id="commands-help" class="red-ui-help" style="display:none;">
    <h4>Lệnh điều khiển đầu vào</h4>
    <p>Gửi các chuỗi sau đến cổng đầu vào để điều khiển hành vi giám sát:</p>
    <ul>
      <li><code>"start"</code> - Bắt đầu giám sát</li>
      <li><code>"stop"</code> - Dừng giám sát</li>
      <li><code>"check"</code> hoặc <code>"status"</code> - Kiểm tra trạng thái ngay lập tức</li>
      <li><code>"stats"</code> - Xuất thông tin thống kê giám sát</li>
      <li><code>"history"</code> - Xuất lịch sử trạng thái</li>
    </ul>
    <p>Cũng có thể gửi lệnh đối tượng:</p>
    <pre>
{
  "action": "configure",
  "pollingInterval": 5000,
  "outputMode": "changes"
}
    </pre>
  </div>

  <div class="form-row">
    <label>Điều khiển giám sát</label>
    <button type="button" id="start-monitoring" class="red-ui-button">
      <i class="fa fa-play"></i> Bắt đầu giám sát
    </button>
    <button type="button" id="stop-monitoring" class="red-ui-button" style="margin-left: 5px;">
      <i class="fa fa-stop"></i> Dừng giám sát
    </button>
    <button type="button" id="view-history" class="red-ui-button" style="margin-left: 10px;">
      <i class="fa fa-history"></i> Xem lịch sử
    </button>
  </div>

  <div id="monitoring-stats" class="status-display">
    <p class="status-item">Thông tin thống kê giám sát sẽ hiển thị ở đây</p>
  </div>
</script>

<script type="text/html" data-help-name="xiaozhi-status">
  <p>Nút xiaozhi-status dùng để giám sát trạng thái kết nối MCP Xiaozhi, trạng thái công cụ và tình trạng sức khỏe hệ thống, cung cấp thông tin trạng thái thời gian thực.</p>

  <h3>Hướng dẫn cấu hình</h3>
  <dl class="message-properties">
    <dt>Cấu hình Xiaozhi <span class="property-type">xiaozhi-config</span></dt>
    <dd>Chọn nút kết nối MCP Xiaozhi cần giám sát</dd>

    <dt>Chế độ giám sát <span class="property-type">string</span></dt>
    <dd>Chế độ hành vi giám sát: Giám sát tự động, giám sát thủ công hoặc giám sát theo lịch</dd>

    <dt>Khoảng thời gian kiểm tra <span class="property-type">number</span></dt>
    <dd>Khoảng thời gian kiểm tra trạng thái trong chế độ tự động hoặc theo lịch</dd>

    <dt>Chế độ xuất <span class="property-type">string</span></dt>
    <dd>Định dạng xuất thông tin trạng thái: Thông tin đầy đủ, chỉ thay đổi hoặc tóm tắt ngắn gọn</dd>

    <dt>Mục giám sát <span class="property-type">boolean</span></dt>
    <dd>Chọn các mục cần bao gồm trong thông tin trạng thái</dd>
  </dl>

  <h3>Thông điệp đầu vào</h3>
  <p>Nhận lệnh điều khiển:</p>
  <dl class="message-properties">
    <dt>payload <span class="property-type">string | object</span></dt>
    <dd>Chuỗi lệnh điều khiển hoặc đối tượng cấu hình</dd>
  </dl>

  <h4>Các lệnh được hỗ trợ</h4>
  <ul>
    <li><code>"start"</code> - Bắt đầu giám sát</li>
    <li><code>"stop"</code> - Dừng giám sát</li>
    <li><code>"check"</code> - Kiểm tra trạng thái ngay lập tức</li>
    <li><code>"stats"</code> - Xuất thông tin thống kê</li>
    <li><code>"history"</code> - Xuất lịch sử</li>
  </ul>

  <h3>Thông điệp đầu ra</h3>
  <h4>Chế độ thông tin đầy đủ</h4>
  <dl class="message-properties">
    <dt>payload.timestamp <span class="property-type">string</span></dt>
    <dd>Dấu thời gian kiểm tra trạng thái</dd>

    <dt>payload.mcp <span class="property-type">object</span></dt>
    <dd>Thông tin trạng thái kết nối MCP</dd>

    <dt>payload.tools <span class="property-type">object</span></dt>
    <dd>Thông tin công cụ đã đăng ký</dd>

    <dt>payload.system <span class="property-type">object</span></dt>
    <dd>Thông tin hệ thống và giám sát</dd>

    <dt>_statusUpdate <span class="property-type">object</span></dt>
    <dd>Thông tin meta cập nhật trạng thái</dd>
  </dl>

  <h4>Chế độ chỉ thay đổi</h4>
  <p>Chỉ xuất khi trạng thái thay đổi, bao gồm các trường bổ sung:</p>
  <dl class="message-properties">
    <dt>payload.changes <span class="property-type">array</span></dt>
    <dd>Danh sách các thay đổi đã xảy ra</dd>

    <dt>payload.previousStatus <span class="property-type">object</span></dt>
    <dd>Thông tin trạng thái trước đó</dd>
  </dl>

  <h3>Thông tin trạng thái MCP</h3>
  <dl class="message-properties">
    <dt>mcp.connected <span class="property-type">boolean</span></dt>
    <dd>Trạng thái kết nối máy chủ MCP</dd>

    <dt>mcp.connectionState <span class="property-type">string</span></dt>
    <dd>Trạng thái kết nối chi tiết</dd>

    <dt>mcp.endpoint <span class="property-type">string</span></dt>
    <dd>Địa chỉ điểm cuối máy chủ MCP</dd>

    <dt>mcp.health <span class="property-type">object</span></dt>
    <dd>Trạng thái sức khỏe kết nối</dd>

    <dt>mcp.stats <span class="property-type">object</span></dt>
    <dd>Thông tin thống kê kết nối</dd>
  </dl>

  <h3>Thông tin trạng thái công cụ</h3>
  <dl class="message-properties">
    <dt>tools.count <span class="property-type">number</span></dt>
    <dd>Số lượng công cụ đã đăng ký</dd>

    <dt>tools.names <span class="property-type">array</span></dt>
    <dd>Danh sách tên công cụ</dd>

    <dt>tools.details <span class="property-type">array</span></dt>
    <dd>Thông tin chi tiết công cụ (khi bao gồm thống kê)</dd>
  </dl>

  <h3>Ví dụ sử dụng</h3>
  <p><strong>Thiết lập giám sát cơ bản</strong></p>
  <ol>
    <li>Chọn nút cấu hình Xiaozhi</li>
    <li>Đặt chế độ giám sát thành "Giám sát tự động"</li>
    <li>Đặt khoảng thời gian kiểm tra là 10 giây</li>
    <li>Chọn chế độ xuất là "Chỉ thay đổi"</li>
    <li>Kích hoạt tất cả các mục giám sát</li>
  </ol>

  <p><strong>Điều khiển giám sát thủ công</strong></p>
  <ol>
    <li>Đặt chế độ giám sát thành "Giám sát thủ công"</li>
    <li>Kết nối nút inject, gửi lệnh "start" để bắt đầu giám sát</li>
    <li>Gửi lệnh "check" để kiểm tra trạng thái thủ công</li>
    <li>Gửi lệnh "stop" để dừng giám sát</li>
  </ol>

  <h3>Sự kiện thay đổi trạng thái</h3>
  <p>Nút sẽ phát hiện và báo cáo các thay đổi trạng thái sau:</p>
  <ul>
    <li>Thay đổi trạng thái kết nối MCP (kết nối/ngắt kết nối)</li>
    <li>Thay đổi số lượng công cụ (đăng ký/hủy đăng ký)</li>
    <li>Thay đổi trạng thái sức khỏe</li>
    <li>Thay đổi điểm cuối kết nối</li>
  </ul>

  <h3>Lưu ý quan trọng</h3>
  <ul>
    <li>Tần suất giám sát không nên quá cao để tránh ảnh hưởng đến hiệu suất hệ thống</li>
    <li>Chế độ chỉ thay đổi có thể giảm đầu ra không cần thiết</li>
    <li>Bao gồm thông tin thống kê sẽ tăng lượng dữ liệu đầu ra</li>
    <li>Trong chế độ thủ công cần chủ động gửi lệnh mới kiểm tra trạng thái</li>
    <li>Lịch sử trạng thái có giới hạn số mục tối đa, vượt quá sẽ tự động dọn dẹp</li>
  </ul>
</script>

<style>
  .red-ui-help {
    font-size: 12px;
    color: #666;
    margin-top: 5px;
  }
  
  .red-ui-help h4 {
    margin: 10px 0 5px 0;
    font-size: 13px;
    font-weight: bold;
  }
  
  .red-ui-help pre {
    background: #f5f5f5;
    padding: 8px;
    margin: 5px 0;
    font-size: 11px;
    border-radius: 3px;
    overflow-x: auto;
  }
  
  .red-ui-help ul {
    margin: 5px 0;
    padding-left: 20px;
  }

  .status-display {
    border: 1px solid #ddd;
    padding: 10px;
    margin: 10px 0;
    background: #f9f9f9;
    border-radius: 4px;
    min-height: 60px;
    max-height: 300px;
    overflow-y: auto;
    font-size: 12px;
  }

  .status-container {
    margin: 0;
  }

  .status-section {
    margin-bottom: 15px;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
  }

  .status-section:last-child {
    border-bottom: none;
  }

  .status-section h4 {
    margin: 0 0 8px 0;
    font-size: 13px;
    color: #333;
  }

  .status-item {
    margin: 3px 0;
    font-size: 12px;
  }

  .status-value {
    font-weight: bold;
  }

  .status-value.connected {
    color: #5cb85c;
  }

  .status-value.disconnected {
    color: #d9534f;
  }

  .status-value.error {
    color: #d9534f;
  }

  .status-value.healthy {
    color: #5cb85c;
  }

  .tool-list {
    margin: 5px 0 5px 20px;
    padding: 0;
  }

  .tool-list li {
    font-size: 11px;
    color: #666;
  }

  .stats-container {
    margin: 0;
  }

  .stats-item {
    margin: 3px 0;
    font-size: 12px;
  }

  .stats-item .monitoring {
    color: #5cb85c;
    font-weight: bold;
  }

  .stats-item .stopped {
    color: #d9534f;
    font-weight: bold;
  }
</style>