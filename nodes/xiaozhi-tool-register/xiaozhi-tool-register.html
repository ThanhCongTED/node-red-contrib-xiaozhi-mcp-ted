<!--
xiaozhi-tool-register Nút đăng ký công cụ
Dùng để đăng ký công cụ thiết bị với máy chủ MCP Xiaozhi
-->

<script type="text/javascript">
  RED.nodes.registerType('xiaozhi-tool-register', {
    category: 'Xiaozhi MCP',
    color: '#87CEEB',
    defaults: {
      name: { value: '' },
      xiaozhi: { value: '', type: 'xiaozhi-config', required: true },
      toolName: { value: '', required: true, validate: RED.validators.regex(/^[a-zA-Z_][a-zA-Z0-9_-]*$/) },
      toolDescription: { value: '', required: true },
      inputSchema: { value: '{\n  "type": "object",\n  "properties": {},\n  "required": []\n}' },
      outputToFlow: { value: true },
      enableValidation: { value: true },
      asyncExecution: { value: false },
      executionTimeout: { value: 30000, validate: RED.validators.number() }
    },
    inputs: 1,
    outputs: 1,
    inputLabels: 'Phản hồi gọi công cụ',
    outputLabels: 'Yêu cầu gọi công cụ',
    icon: 'font-awesome/fa-cogs',
    label: function() {
      return this.name || this.toolName || 'Đăng ký công cụ';
    },
    labelStyle: function() {
      return this.name ? 'node_label_italic' : '';
    },
    paletteLabel: 'Đăng ký công cụ',
    oneditprepare: function() {
      var node = this;
      
      // Khởi tạo trình soạn thảo CodeMirror cho JSON Schema
      var schemaEditor = RED.editor.createEditor({
        id: 'node-input-inputSchema-editor',
        mode: 'ace/mode/json',
        value: node.inputSchema || '{\n  "type": "object",\n  "properties": {},\n  "required": []\n}'
      });

      // Lắng nghe thay đổi tên công cụ, tự động tạo mô tả
      $('#node-input-toolName').on('blur', function() {
        var toolName = $(this).val();
        var descriptionField = $('#node-input-toolDescription');
        
        if (toolName && !descriptionField.val()) {
          // Tự động tạo mô tả
          var description = toolName.replace(/_/g, ' ').replace(/([A-Z])/g, ' $1').toLowerCase();
          description = description.charAt(0).toUpperCase() + description.slice(1);
          descriptionField.val(description + ' công cụ');
        }
      });

      // Xác thực JSON Schema
      var validateSchema = function() {
        try {
          var schema = schemaEditor.getValue();
          JSON.parse(schema);
          $('#schema-error').hide();
          $('#schema-valid').show();
          return true;
        } catch (e) {
          $('#schema-error').text('Lỗi định dạng JSON Schema: ' + e.message).show();
          $('#schema-valid').hide();
          return false;
        }
      };

      // Lắng nghe thay đổi trình soạn thảo Schema
      schemaEditor.on('change', function() {
        setTimeout(validateSchema, 500);
      });

      // Mẫu Schema định nghĩa trước
      $('#schema-template').on('change', function() {
        var template = $(this).val();
        var schemas = {
          'simple-string': {
            type: 'object',
            properties: {
              value: {
                type: 'string',
                description: 'Giá trị chuỗi'
              }
            },
            required: ['value']
          },
          'simple-number': {
            type: 'object',
            properties: {
              value: {
                type: 'number',
                description: 'Giá trị số'
              }
            },
            required: ['value']
          },
          'led-control': {
            type: 'object',
            properties: {
              pin: {
                type: 'number',
                description: 'Số chân LED',
                minimum: 0,
                maximum: 40
              },
              state: {
                type: 'boolean',
                description: 'Trạng thái LED (true=bật, false=tắt)'
              }
            },
            required: ['pin', 'state']
          },
          'sensor-read': {
            type: 'object',
            properties: {
              sensorType: {
                type: 'string',
                description: 'Loại cảm biến',
                enum: ['temperature', 'humidity', 'pressure', 'light']
              },
              pin: {
                type: 'number',
                description: 'Số chân cảm biến',
                minimum: 0,
                maximum: 40
              }
            },
            required: ['sensorType', 'pin']
          },
          'motor-control': {
            type: 'object',
            properties: {
              motorId: {
                type: 'number',
                description: 'ID động cơ',
                minimum: 1,
                maximum: 4
              },
              speed: {
                type: 'number',
                description: 'Tốc độ động cơ (-100 đến 100)',
                minimum: -100,
                maximum: 100
              },
              duration: {
                type: 'number',
                description: 'Thời gian chạy (miligiây)',
                minimum: 0
              }
            },
            required: ['motorId', 'speed']
          }
        };

        if (template && schemas[template]) {
          schemaEditor.setValue(JSON.stringify(schemas[template], null, 2));
          validateSchema();
        }
      });

      // Xác thực ban đầu
      setTimeout(validateSchema, 100);

      // Nút kiểm tra kết nối
      $('#test-connection').on('click', function() {
        var configNode = $('#node-input-xiaozhi').val();
        if (!configNode) {
          RED.notify('Vui lòng chọn nút cấu hình Xiaozhi trước', 'warn');
          return;
        }

        var button = $(this);
        button.prop('disabled', true).text('Đang kiểm tra...');

        $.ajax({
          url: 'xiaozhi-config/' + configNode + '/status',
          method: 'GET',
          success: function(data) {
            if (data.isConnected) {
              RED.notify('Kết nối bình thường', 'success');
            } else {
              RED.notify('Kết nối bất thường: ' + (data.lastError || 'Chưa kết nối'), 'warn');
            }
          },
          error: function() {
            RED.notify('Không thể lấy trạng thái kết nối', 'error');
          },
          complete: function() {
            button.prop('disabled', false).text('Kiểm tra kết nối');
          }
        });
      });

      // Nút lấy thông tin thống kê
      $('#get-stats').on('click', function() {
        if (node.id) {
          $.ajax({
            url: 'xiaozhi-tool-register/' + node.id + '/stats',
            method: 'GET',
            success: function(data) {
              var statsText = [
                'Tên công cụ: ' + data.toolName,
                'Trạng thái đăng ký: ' + (data.registered ? 'Đã đăng ký' : 'Chưa đăng ký'),
                'Số lần gọi: ' + data.callCount,
                'Thời gian thực hiện trung bình: ' + data.averageExecutionTime + 'ms',
                'Cuộc gọi đang chờ xử lý: ' + data.pendingCalls
              ];
              
              if (data.lastCalledAt) {
                statsText.push('Lần gọi cuối: ' + new Date(data.lastCalledAt).toLocaleString());
              }
              
              RED.notify(statsText.join('\n'), 'success');
            },
            error: function() {
              RED.notify('Không thể lấy thông tin thống kê', 'error');
            }
          });
        } else {
          RED.notify('Vui lòng lưu nút trước khi xem thông tin thống kê', 'warn');
        }
      });

      // Chuyển đổi đơn vị thời gian chờ
      $('#timeout-unit').on('change', function() {
        var unit = $(this).val();
        var timeoutField = $('#node-input-executionTimeout');
        var currentValue = parseInt(timeoutField.val()) || 30000;
        
        switch(unit) {
          case 'seconds':
            timeoutField.val(Math.round(currentValue / 1000));
            break;
          case 'minutes':
            timeoutField.val(Math.round(currentValue / 60000));
            break;
          default: // milliseconds
            // Giữ nguyên giá trị
            break;
        }
      });

      // Chuyển đổi thông tin trợ giúp
      $('.help-toggle').on('click', function() {
        var target = $(this).data('target');
        $(target).toggle();
      });
    },
    oneditsave: function() {
      // Lưu nội dung trình soạn thảo Schema
      var schemaEditor = RED.editor.getEditor('node-input-inputSchema-editor');
      if (schemaEditor) {
        this.inputSchema = schemaEditor.getValue();
      }

      // Chuyển đổi đơn vị thời gian chờ
      var unit = $('#timeout-unit').val();
      var timeout = parseInt($('#node-input-executionTimeout').val()) || 30;
      
      switch(unit) {
        case 'seconds':
          this.executionTimeout = timeout * 1000;
          break;
        case 'minutes':
          this.executionTimeout = timeout * 60000;
          break;
        default: // milliseconds
          this.executionTimeout = timeout;
          break;
      }
    },
    oneditcancel: function() {
      // Dọn dẹp trình soạn thảo
      var schemaEditor = RED.editor.getEditor('node-input-inputSchema-editor');
      if (schemaEditor) {
        schemaEditor.destroy();
      }
    }
  });
</script>

<script type="text/html" data-template-name="xiaozhi-tool-register">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Tên nút</label>
    <input type="text" id="node-input-name" placeholder="Tên nút tùy chọn">
  </div>

  <div class="form-row">
    <label for="node-input-xiaozhi"><i class="fa fa-plug"></i> Cấu hình Xiaozhi</label>
    <input type="text" id="node-input-xiaozhi">
    <button type="button" id="test-connection" class="red-ui-button" style="margin-left: 10px;">
      <i class="fa fa-check"></i> Kiểm tra kết nối
    </button>
  </div>

  <hr>

  <div class="form-row">
    <label for="node-input-toolName"><i class="fa fa-cog"></i> Tên công cụ</label>
    <input type="text" id="node-input-toolName" placeholder="my_tool">
    <div class="red-ui-help">
      <p>Tên công cụ phải là duy nhất, chỉ có thể chứa chữ cái, số, dấu gạch dưới và dấu gạch ngang, không được bắt đầu bằng số.</p>
    </div>
  </div>

  <div class="form-row">
    <label for="node-input-toolDescription"><i class="fa fa-info-circle"></i> Mô tả công cụ</label>
    <input type="text" id="node-input-toolDescription" placeholder="Mô tả chức năng của công cụ">
    <div class="red-ui-help">
      <p>Mô tả ngắn gọn, rõ ràng về chức năng của công cụ, sẽ hiển thị trên nền tảng AI Xiaozhi.</p>
    </div>
  </div>

  <div class="form-row">
    <label for="schema-template"><i class="fa fa-code"></i> Mẫu Schema</label>
    <select id="schema-template">
      <option value="">Chọn mẫu định nghĩa trước...</option>
      <option value="simple-string">Tham số chuỗi đơn giản</option>
      <option value="simple-number">Tham số số đơn giản</option>
      <option value="led-control">Điều khiển LED</option>
      <option value="sensor-read">Đọc cảm biến</option>
      <option value="motor-control">Điều khiển động cơ</option>
    </select>
    <button type="button" class="help-toggle red-ui-button" data-target="#schema-help" style="margin-left: 10px;">
      <i class="fa fa-question-circle"></i> Trợ giúp
    </button>
  </div>

  <div class="form-row">
    <label for="node-input-inputSchema-editor">Schema tham số đầu vào</label>
    <div style="height: 300px; min-height:200px;" class="node-text-editor" id="node-input-inputSchema-editor"></div>
    <div id="schema-valid" style="display:none; color: green; margin-top: 5px;">
      <i class="fa fa-check"></i> Định dạng Schema chính xác
    </div>
    <div id="schema-error" style="display:none; color: red; margin-top: 5px;">
      <i class="fa fa-exclamation-triangle"></i> <span></span>
    </div>
  </div>

  <div id="schema-help" class="red-ui-help" style="display:none;">
    <h4>Giải thích JSON Schema</h4>
    <p>JSON Schema dùng để định nghĩa định dạng tham số mà công cụ chấp nhận. Các trường thường dùng:</p>
    <ul>
      <li><strong>type</strong>: Kiểu dữ liệu (object, string, number, boolean, array)</li>
      <li><strong>properties</strong>: Định nghĩa thuộc tính đối tượng</li>
      <li><strong>required</strong>: Danh sách các trường bắt buộc</li>
      <li><strong>description</strong>: Mô tả trường</li>
      <li><strong>minimum/maximum</strong>: Giới hạn phạm vi số</li>
      <li><strong>enum</strong>: Danh sách giá trị liệt kê</li>
    </ul>
    <p>Ví dụ: Schema điều khiển đèn LED</p>
    <pre>{
  "type": "object",
  "properties": {
    "pin": {
      "type": "number",
      "description": "Số chân LED",
      "minimum": 0,
      "maximum": 40
    },
    "state": {
      "type": "boolean",
      "description": "Trạng thái LED"
    }
  },
  "required": ["pin", "state"]
}</pre>
  </div>

  <hr>

  <div class="form-row">
    <label>&nbsp;</label>
    <input type="checkbox" id="node-input-outputToFlow" style="display:inline-block; width:auto; vertical-align:top;">
    <label for="node-input-outputToFlow" style="width:70%;">Xuất ra luồng xử lý</label>
    <div class="red-ui-help">
      <p>Khi bật, cuộc gọi công cụ sẽ được gửi đến luồng để xử lý; khi tắt sẽ trả về phản hồi mặc định.</p>
    </div>
  </div>

  <div class="form-row">
    <label>&nbsp;</label>
    <input type="checkbox" id="node-input-enableValidation" style="display:inline-block; width:auto; vertical-align:top;">
    <label for="node-input-enableValidation" style="width:70%;">Kích hoạt xác thực tham số</label>
    <div class="red-ui-help">
      <p>Xác thực tham số đầu vào theo Schema, nên giữ bật.</p>
    </div>
  </div>

  <div class="form-row">
    <label>&nbsp;</label>
    <input type="checkbox" id="node-input-asyncExecution" style="display:inline-block; width:auto; vertical-align:top;">
    <label for="node-input-asyncExecution" style="width:70%;">Thực thi không đồng bộ</label>
    <div class="red-ui-help">
      <p>Kích hoạt chế độ thực thi không đồng bộ, phù hợp với các công cụ tốn nhiều thời gian.</p>
    </div>
  </div>

  <div class="form-row">
    <label for="node-input-executionTimeout"><i class="fa fa-clock-o"></i> Thời gian chờ thực thi</label>
    <input type="number" id="node-input-executionTimeout" style="width: 60px;" min="1" step="1" value="30">
    <select id="timeout-unit" style="width: 80px; margin-left: 5px;">
      <option value="milliseconds">Miligiây</option>
      <option value="seconds" selected>Giây</option>
      <option value="minutes">Phút</option>
    </select>
    <div class="red-ui-help">
      <p>Thời gian chờ tối đa cho việc thực thi công cụ, sau thời gian này sẽ trả về phản hồi lỗi.</p>
    </div>
  </div>

  <div class="form-row">
    <label>&nbsp;</label>
    <button type="button" id="get-stats" class="red-ui-button">
      <i class="fa fa-bar-chart"></i> Xem thống kê
    </button>
    <div class="red-ui-help">
      <p>Xem trạng thái đăng ký và thông tin thống kê cuộc gọi của công cụ.</p>
    </div>
  </div>
</script>

<script type="text/html" data-help-name="xiaozhi-tool-register">
  <p>Nút xiaozhi-tool-register dùng để đăng ký công cụ thiết bị với máy chủ MCP Xiaozhi, cho phép AI có thể gọi các chức năng của thiết bị của bạn.</p>

  <h3>Hướng dẫn cấu hình</h3>
  <dl class="message-properties">
    <dt>Cấu hình Xiaozhi <span class="property-type">xiaozhi-config</span></dt>
    <dd>Chọn nút kết nối MCP Xiaozhi đã cấu hình</dd>

    <dt>Tên công cụ <span class="property-type">string</span></dt>
    <dd>Định danh duy nhất cho công cụ, chỉ có thể chứa chữ cái, số, dấu gạch dưới và dấu gạch ngang</dd>

    <dt>Mô tả công cụ <span class="property-type">string</span></dt>
    <dd>Mô tả ngắn gọn về chức năng công cụ, sẽ hiển thị trên nền tảng AI</dd>

    <dt>Schema tham số đầu vào <span class="property-type">JSON</span></dt>
    <dd>Định nghĩa định dạng tham số mà công cụ chấp nhận, sử dụng tiêu chuẩn JSON Schema</dd>

    <dt>Xuất ra luồng xử lý <span class="property-type">boolean</span></dt>
    <dd>Khi bật, cuộc gọi công cụ sẽ xuất ra luồng; khi tắt sẽ trả về phản hồi mặc định</dd>

    <dt>Kích hoạt xác thực tham số <span class="property-type">boolean</span></dt>
    <dd>Xác thực tính hợp lệ của tham số đầu vào theo Schema</dd>

    <dt>Thời gian chờ thực thi <span class="property-type">number</span></dt>
    <dd>Thời gian chờ tối đa cho việc thực thi công cụ</dd>
  </dl>

  <h3>Thông điệp đầu vào</h3>
  <p>Nhận thông điệp phản hồi cuộc gọi công cụ:</p>
  <dl class="message-properties">
    <dt>payload <span class="property-type">object</span></dt>
    <dd>Kết quả thực thi công cụ</dd>

    <dt>_mcpCallId <span class="property-type">string</span></dt>
    <dd>Định danh duy nhất của cuộc gọi công cụ, dùng để khớp phản hồi</dd>
  </dl>

  <h3>Thông điệp đầu ra</h3>
  <p>Khi công cụ được gọi sẽ xuất ra:</p>
  <dl class="message-properties">
    <dt>payload.toolName <span class="property-type">string</span></dt>
    <dd>Tên công cụ được gọi</dd>

    <dt>payload.arguments <span class="property-type">object</span></dt>
    <dd>Tham số cuộc gọi công cụ</dd>

    <dt>payload.callId <span class="property-type">string</span></dt>
    <dd>Định danh duy nhất của cuộc gọi công cụ</dd>

    <dt>payload.timestamp <span class="property-type">string</span></dt>
    <dd>Dấu thời gian cuộc gọi</dd>

    <dt>_mcpCallId <span class="property-type">string</span></dt>
    <dd>ID cuộc gọi dùng để khớp phản hồi</dd>
  </dl>

  <h3>Ví dụ sử dụng</h3>
  <p><strong>Công cụ điều khiển LED</strong></p>
  <ol>
    <li>Tên công cụ: <code>led_control</code></li>
    <li>Mô tả công cụ: <code>Điều khiển trạng thái bật/tắt đèn LED</code></li>
    <li>Schema đầu vào:
      <pre>{
  "type": "object",
  "properties": {
    "pin": {
      "type": "number",
      "description": "Số chân LED",
      "minimum": 0,
      "maximum": 40
    },
    "state": {
      "type": "boolean", 
      "description": "Trạng thái LED"
    }
  },
  "required": ["pin", "state"]
}</pre>
    </li>
    <li>Kết nối với nút function để xử lý logic điều khiển LED cụ thể</li>
    <li>Trả về kết quả thực thi: <code>msg.payload = {result: "LED đã bật"}</code></li>
  </ol>

  <h3>Lưu ý quan trọng</h3>
  <ul>
    <li>Tên công cụ phải là duy nhất trong cùng một kết nối MCP</li>
    <li>Định dạng JSON Schema phải chính xác, nên sử dụng mẫu có sẵn</li>
    <li>Khi kích hoạt "Xuất ra luồng xử lý", phải trả về phản hồi qua cổng đầu vào</li>
    <li>Thông điệp phản hồi phải chứa trường <code>_mcpCallId</code> để khớp</li>
    <li>Sau khi hết thời gian chờ sẽ tự động trả về phản hồi lỗi, tránh để AI chờ quá lâu</li>
  </ul>
</script>

<style>
  .red-ui-help {
    font-size: 12px;
    color: #666;
    margin-top: 5px;
  }
  
  .red-ui-help h4 {
    margin: 10px 0 5px 0;
    font-size: 13px;
    font-weight: bold;
  }
  
  .red-ui-help pre {
    background: #f5f5f5;
    padding: 8px;
    margin: 5px 0;
    font-size: 11px;
    border-radius: 3px;
    overflow-x: auto;
  }
  
  .red-ui-help ul {
    margin: 5px 0;
    padding-left: 20px;
  }
  
  .help-toggle {
    margin-left: 10px;
  }
  
  #schema-valid {
    color: #5cb85c;
  }
  
  #schema-error {
    color: #d9534f;
  }
</style>