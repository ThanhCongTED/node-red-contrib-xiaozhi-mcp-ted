<!--
Nút gọi công cụ xiaozhi-tool-call
Dùng để chủ động gọi các công cụ trên nền tảng Xiaozhi hoặc các thiết bị khác
-->

<script type="text/javascript">
  RED.nodes.registerType('xiaozhi-tool-call', {
    category: '小智MCP', // Giữ nguyên category
    color: '#98FB98',
    defaults: {
      name: { value: '' },
      xiaozhi: { value: '', type: 'xiaozhi-config', required: true },
      targetTool: { value: '', required: true },
      toolArguments: { value: '{}' },
      argumentsSource: { value: 'configured' },
      outputMode: { value: 'result' },
      errorHandling: { value: 'throw' },
      callTimeout: { value: 30000, validate: RED.validators.number() },
      retryAttempts: { value: 0, validate: RED.validators.number() },
      retryDelay: { value: 1000, validate: RED.validators.number() }
    },
    inputs: 1,
    outputs: function() {
      return this.outputMode === 'split' ? 2 : 1;
    },
    outputLabels: function() {
      if (this.outputMode === 'split') {
        return ['Kết quả công cụ', 'Siêu dữ liệu gọi'];
      }
      return 'Kết quả công cụ';
    },
    inputLabels: 'Kích hoạt gọi',
    icon: 'font-awesome/fa-paper-plane',
    label: function() {
      return this.name || (this.targetTool ? `Gọi ${this.targetTool}` : 'Gọi công cụ');
    },
    labelStyle: function() {
      return this.name ? 'node_label_italic' : '';
    },
    paletteLabel: 'Gọi công cụ',
    oneditprepare: function() {
      var node = this;
      
      // Khởi tạo trình chỉnh sửa đối số công cụ
      var argsEditor = RED.editor.createEditor({
        id: 'node-input-toolArguments-editor',
        mode: 'ace/mode/json',
        value: node.toolArguments || '{}'
      });

      // Trình chọn công cụ
      var toolSelect = $('#node-input-targetTool');
      var refreshToolsBtn = $('#refresh-tools');
      var testCallBtn = $('#test-call');

      // Làm mới danh sách công cụ có sẵn
      var refreshTools = function() {
        var configNode = $('#node-input-xiaozhi').val();
        if (!configNode) {
          toolSelect.empty().append('<option value="">Vui lòng chọn nút cấu hình Xiaozhi trước</option>');
          return;
        }

        refreshToolsBtn.prop('disabled', true).text('Đang làm mới...');

        $.ajax({
          url: 'xiaozhi-tool-call/' + (node.id || 'temp') + '/tools',
          method: 'GET',
          data: { config: configNode },
          success: function(data) {
            toolSelect.empty();
            
            if (data.tools && data.tools.length > 0) {
              toolSelect.append('<option value="">Chọn công cụ...</option>');
              data.tools.forEach(function(tool) {
                var selected = tool.name === node.targetTool ? 'selected' : '';
                toolSelect.append(`<option value="${tool.name}" ${selected}>${tool.name} - ${tool.description}</option>`);
              });
            } else {
              toolSelect.append('<option value="">Không có công cụ nào khả dụng</option>');
            }
          },
          error: function() {
            toolSelect.empty().append('<option value="">Không thể lấy danh sách công cụ</option>');
          },
          complete: function() {
            refreshToolsBtn.prop('disabled', false).text('Làm mới công cụ');
          }
        });
      };

      // Sự kiện nhấp nút làm mới công cụ
      refreshToolsBtn.on('click', refreshTools);

      // Làm mới công cụ khi nút cấu hình thay đổi
      $('#node-input-xiaozhi').on('change', refreshTools);

      // Xử lý thay đổi nguồn đối số
      $('#node-input-argumentsSource').on('change', function() {
        var source = $(this).val();
        var argsContainer = $('#args-editor-container');
        var argsHelp = $('#args-source-help');
        
        if (source === 'configured') {
          argsContainer.show();
          argsHelp.text('Cấu hình các đối số công cụ cố định trong trình chỉnh sửa bên dưới');
        } else {
          argsContainer.hide();
          var helpTexts = {
            'msg': 'Sử dụng payload của tin nhắn đầu vào làm đối số công cụ',
            'msg.args': 'Sử dụng thuộc tính args của tin nhắn đầu vào làm đối số công cụ',
            'flow': 'Sử dụng biến toolArguments trong ngữ cảnh Flow',
            'global': 'Sử dụng biến toolArguments trong ngữ cảnh Global'
          };
          argsHelp.text(helpTexts[source] || '');
        }
      });

      // Xử lý thay đổi chế độ đầu ra
      $('#node-input-outputMode').on('change', function() {
        var mode = $(this).val();
        var helpTexts = {
          'result': 'Chỉ xuất kết quả thực thi công cụ',
          'full': 'Xuất đối tượng phản hồi công cụ đầy đủ',
          'split': 'Xuất riêng kết quả và siêu dữ liệu ra hai cổng'
        };
        $('#output-mode-help').text(helpTexts[mode] || '');
        
        // Cập nhật hiển thị cổng đầu ra
        if (mode === 'split') {
          $('.output-labels').show();
        } else {
          $('.output-labels').hide();
        }
      });

      // Xử lý thay đổi chế độ xử lý lỗi
      $('#node-input-errorHandling').on('change', function() {
        var mode = $(this).val();
        var helpTexts = {
          'throw': 'Ném ra ngoại lệ, nút hiển thị trạng thái lỗi',
          'output': 'Xuất lỗi dưới dạng tin nhắn',
          'ignore': 'Bỏ qua lỗi, không xuất bất kỳ nội dung nào'
        };
        $('#error-handling-help').text(helpTexts[mode] || '');
      });

      // Xác thực đối số JSON
      var validateArgs = function() {
        try {
          var args = argsEditor.getValue();
          JSON.parse(args);
          $('#args-error').hide();
          $('#args-valid').show();
          return true;
        } catch (e) {
          $('#args-error').text('Lỗi định dạng JSON: ' + e.message).show();
          $('#args-valid').hide();
          return false;
        }
      };

      // Lắng nghe thay đổi trình chỉnh sửa đối số
      argsEditor.on('change', function() {
        setTimeout(validateArgs, 500);
      });

      // Kiểm tra gọi công cụ
      testCallBtn.on('click', function() {
        var toolName = toolSelect.val();
        var args = {};

        if (!toolName) {
          RED.notify('Vui lòng chọn công cụ để kiểm tra', 'warn');
          return;
        }

        try {
          args = JSON.parse(argsEditor.getValue());
        } catch (e) {
          RED.notify('Lỗi định dạng JSON đối số công cụ', 'error');
          return;
        }

        var button = $(this);
        button.prop('disabled', true).text('Đang kiểm tra...');

        $.ajax({
          url: 'xiaozhi-tool-call/' + (node.id || 'temp') + '/test',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ toolName, args }),
          success: function(data) {
            if (data.success) {
              RED.notify('Gọi công cụ thành công', 'success');
              console.log('Kết quả gọi công cụ:', data.result);
            } else {
              RED.notify('Gọi công cụ thất bại: ' + data.error, 'error');
            }
          },
          error: function(xhr) {
            var errorMsg = xhr.responseJSON ? xhr.responseJSON.error : 'Kiểm tra thất bại';
            RED.notify('Lỗi kiểm tra: ' + errorMsg, 'error');
          },
          complete: function() {
            button.prop('disabled', false).text('Kiểm tra gọi');
          }
        });
      });

      // Lấy thông tin thống kê
      $('#get-stats').on('click', function() {
        if (node.id) {
          $.ajax({
            url: 'xiaozhi-tool-call/' + node.id + '/stats',
            method: 'GET',
            success: function(data) {
              var statsText = [
                'Công cụ mục tiêu: ' + data.targetTool,
                'Tổng số lần gọi: ' + data.totalCalls,
                'Số lần thành công: ' + data.successfulCalls,
                'Số lần thất bại: ' + data.failedCalls,
                'Tỷ lệ thành công: ' + data.successRate,
                'Thời gian phản hồi trung bình: ' + data.averageResponseTime + 'ms'
              ];
              
              if (data.lastCallAt) {
                statsText.push('Lần gọi cuối: ' + new Date(data.lastCallAt).toLocaleString());
              }
              
              if (data.lastError) {
                statsText.push('Lỗi cuối cùng: ' + data.lastError);
              }
              
              RED.notify(statsText.join('\n'), 'success');
            },
            error: function() {
              RED.notify('Không thể lấy thông tin thống kê', 'error');
            }
          });
        } else {
          RED.notify('Vui lòng lưu nút trước khi xem thông tin thống kê', 'warn');
        }
      });

      // Chuyển đổi đơn vị thời gian chờ
      $('#timeout-unit').on('change', function() {
        var unit = $(this).val();
        var timeoutField = $('#node-input-callTimeout');
        var currentValue = parseInt(timeoutField.val()) || 30000;
        
        switch(unit) {
          case 'seconds':
            timeoutField.val(Math.round(currentValue / 1000));
            break;
          case 'minutes':
            timeoutField.val(Math.round(currentValue / 60000));
            break;
          default: // milliseconds
            // Giữ nguyên giá trị
            break;
        }
      });

      // Mẫu đối số định nghĩa trước
      $('#args-template').on('change', function() {
        var template = $(this).val();
        var templates = {
          'led-on': {
            pin: 2,
            state: true
          },
          'led-off': {
            pin: 2,
            state: false
          },
          'sensor-temp': {
            sensorType: 'temperature',
            pin: 4
          },
          'motor-forward': {
            motorId: 1,
            speed: 50,
            duration: 3000
          },
          'system-info': {}
        };

        if (template && templates[template]) {
          argsEditor.setValue(JSON.stringify(templates[template], null, 2));
          validateArgs();
        }
      });

      // Khởi tạo
      setTimeout(function() {
        $('#node-input-argumentsSource').trigger('change');
        $('#node-input-outputMode').trigger('change');
        $('#node-input-errorHandling').trigger('change');
        validateArgs();
        refreshTools();
      }, 100);
    },
    oneditsave: function() {
      // Lưu nội dung trình chỉnh sửa đối số
      var argsEditor = RED.editor.getEditor('node-input-toolArguments-editor');
      if (argsEditor) {
        this.toolArguments = argsEditor.getValue();
      }

      // Chuyển đổi đơn vị thời gian chờ
      var unit = $('#timeout-unit').val();
      var timeout = parseInt($('#node-input-callTimeout').val()) || 30;
      
      switch(unit) {
        case 'seconds':
          this.callTimeout = timeout * 1000;
          break;
        case 'minutes':
          this.callTimeout = timeout * 60000;
          break;
        default: // milliseconds
          this.callTimeout = timeout;
          break;
      }
    },
    oneditcancel: function() {
      // Dọn dẹp trình chỉnh sửa
      var argsEditor = RED.editor.getEditor('node-input-toolArguments-editor');
      if (argsEditor) {
        argsEditor.destroy();
      }
    }
  });
</script>

<script type="text/html" data-template-name="xiaozhi-tool-call">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Tên nút</label>
    <input type="text" id="node-input-name" placeholder="Tên nút (tùy chọn)">
  </div>

  <div class="form-row">
    <label for="node-input-xiaozhi"><i class="fa fa-plug"></i> Cấu hình Xiaozhi</label>
    <input type="text" id="node-input-xiaozhi">
  </div>

  <hr>

  <div class="form-row">
    <label for="node-input-targetTool"><i class="fa fa-cog"></i> Công cụ mục tiêu</label>
    <select id="node-input-targetTool" style="width: 60%;">
      <option value="">Chọn công cụ...</option>
    </select>
    <button type="button" id="refresh-tools" class="red-ui-button" style="margin-left: 10px;">
      <i class="fa fa-refresh"></i> Làm mới công cụ
    </button>
  </div>

  <div class="form-row">
    <label for="node-input-argumentsSource"><i class="fa fa-code"></i> Nguồn đối số</label>
    <select id="node-input-argumentsSource">
      <option value="configured">Đối số cấu hình</option>
      <option value="msg">msg.payload</option>
      <option value="msg.args">msg.args</option>
      <option value="flow">Ngữ cảnh Flow</option>
      <option value="global">Ngữ cảnh Global</option>
    </select>
    <div class="red-ui-help">
      <p id="args-source-help">Cấu hình các đối số công cụ cố định trong trình chỉnh sửa bên dưới</p>
    </div>
  </div>

  <div id="args-editor-container">
    <div class="form-row">
      <label for="args-template">Mẫu đối số</label>
      <select id="args-template">
        <option value="">Chọn mẫu định nghĩa trước...</option>
        <option value="led-on">Bật LED</option>
        <option value="led-off">Tắt LED</option>
        <option value="sensor-temp">Cảm biến nhiệt độ</option>
        <option value="motor-forward">Động cơ tiến</option>
        <option value="system-info">Thông tin hệ thống</option>
      </select>
    </div>

    <div class="form-row">
      <label for="node-input-toolArguments-editor">Đối số công cụ</label>
      <div style="height: 200px; min-height:150px;" class="node-text-editor" id="node-input-toolArguments-editor"></div>
      <div id="args-valid" style="display:none; color: green; margin-top: 5px;">
        <i class="fa fa-check"></i> Định dạng đối số chính xác
      </div>
      <div id="args-error" style="display:none; color: red; margin-top: 5px;">
        <i class="fa fa-exclamation-triangle"></i> <span></span>
      </div>
    </div>
  </div>

  <hr>

  <div class="form-row">
    <label for="node-input-outputMode"><i class="fa fa-share"></i> Chế độ đầu ra</label>
    <select id="node-input-outputMode">
      <option value="result">Chỉ kết quả</option>
      <option value="full">Phản hồi đầy đủ</option>
      <option value="split">Tách đầu ra</option>
    </select>
    <div class="red-ui-help">
      <p id="output-mode-help">Chỉ xuất kết quả thực thi công cụ</p>
    </div>
  </div>

  <div class="output-labels" style="display:none;">
    <div class="red-ui-help">
      <p><strong>Chế độ tách đầu ra：</strong></p>
      <ul>
        <li>Cổng đầu ra 1：Kết quả thực thi công cụ</li>
        <li>Cổng đầu ra 2：Siêu dữ liệu gọi (thời gian phản hồi, trạng thái, v.v.)</li>
      </ul>
    </div>
  </div>

  <div class="form-row">
    <label for="node-input-errorHandling"><i class="fa fa-exclamation-triangle"></i> Xử lý lỗi</label>
    <select id="node-input-errorHandling">
      <option value="throw">Ném ngoại lệ</option>
      <option value="output">Xuất lỗi</option>
      <option value="ignore">Bỏ qua lỗi</option>
    </select>
    <div class="red-ui-help">
      <p id="error-handling-help">Ném ra ngoại lệ, nút hiển thị trạng thái lỗi</p>
    </div>
  </div>

  <hr>

  <div class="form-row">
    <label for="node-input-callTimeout"><i class="fa fa-clock-o"></i> Thời gian chờ gọi</label>
    <input type="number" id="node-input-callTimeout" style="width: 60px;" min="1" step="1" value="30">
    <select id="timeout-unit" style="width: 80px; margin-left: 5px;">
      <option value="milliseconds">Mili giây</option>
      <option value="seconds" selected>Giây</option>
      <option value="minutes">Phút</option>
    </select>
  </div>

  <div class="form-row">
    <label for="node-input-retryAttempts"><i class="fa fa-repeat"></i> Số lần thử lại</label>
    <input type="number" id="node-input-retryAttempts" style="width: 60px;" min="0" max="10" step="1">
    <div class="red-ui-help">
      <p>Số lần thử lại sau khi gọi công cụ thất bại (0 nghĩa là không thử lại)</p>
    </div>
  </div>

  <div class="form-row">
    <label for="node-input-retryDelay"><i class="fa fa-hourglass"></i> Độ trễ thử lại</label>
    <input type="number" id="node-input-retryDelay" style="width: 80px;" min="100" step="100"> Mili giây
    <div class="red-ui-help">
      <p>Thời gian chờ giữa các lần thử lại</p>
    </div>
  </div>

  <div class="form-row">
    <label>&nbsp;</label>
    <button type="button" id="test-call" class="red-ui-button">
      <i class="fa fa-play"></i> Kiểm tra gọi
    </button>
    <button type="button" id="get-stats" class="red-ui-button" style="margin-left: 10px;">
      <i class="fa fa-bar-chart"></i> Xem thống kê
    </button>
  </div>
</script>

<script type="text/html" data-help-name="xiaozhi-tool-call">
  <p>Nút xiaozhi-tool-call dùng để chủ động gọi các công cụ đã đăng ký trên nền tảng Xiaozhi hoặc các thiết bị khác, thực hiện tương tác giữa các thiết bị.</p>

  <h3>Mô tả cấu hình</h3>
  <dl class="message-properties">
    <dt>Cấu hình Xiaozhi <span class="property-type">xiaozhi-config</span></dt>
    <dd>Chọn nút kết nối MCP Xiaozhi đã cấu hình</dd>

    <dt>Công cụ mục tiêu <span class="property-type">string</span></dt>
    <dd>Tên công cụ cần gọi, có thể chọn từ danh sách công cụ có sẵn</dd>

    <dt>Nguồn đối số <span class="property-type">string</span></dt>
    <dd>Nguồn của đối số công cụ: đối số cấu hình, msg.payload, msg.args, ngữ cảnh Flow hoặc ngữ cảnh Global</dd>

    <dt>Chế độ đầu ra <span class="property-type">string</span></dt>
    <dd>Định dạng đầu ra kết quả: chỉ kết quả, phản hồi đầy đủ hoặc tách đầu ra</dd>

    <dt>Xử lý lỗi <span class="property-type">string</span></dt>
    <dd>Cách xử lý lỗi: ném ngoại lệ, xuất lỗi hoặc bỏ qua lỗi</dd>

    <dt>Thời gian chờ gọi <span class="property-type">number</span></dt>
    <dd>Thời gian chờ tối đa cho việc gọi công cụ</dd>

    <dt>Cài đặt thử lại <span class="property-type">number</span></dt>
    <dd>Số lần thử lại sau thất bại và thời gian trễ</dd>
  </dl>

  <h3>Tin nhắn đầu vào</h3>
  <p>Tin nhắn kích hoạt gọi công cụ：</p>
  <dl class="message-properties">
    <dt>payload <span class="property-type">any</span></dt>
    <dd>Khi nguồn đối số là "msg.payload", được dùng làm đối số công cụ</dd>

    <dt>args <span class="property-type">object</span></dt>
    <dd>Khi nguồn đối số là "msg.args", được dùng làm đối số công cụ</dd>

    <dt>tool <span class="property-type">string</span></dt>
    <dd>Tùy chọn, chỉ định động tên công cụ cần gọi</dd>
  </dl>

  <h3>Tin nhắn đầu ra</h3>
  <h4>Chế độ chỉ kết quả</h4>
  <dl class="message-properties">
    <dt>payload <span class="property-type">any</span></dt>
    <dd>Dữ liệu kết quả thực thi công cụ</dd>

    <dt>_toolCall <span class="property-type">object</span></dt>
    <dd>Thông tin siêu dữ liệu gọi: tên công cụ, dấu thời gian, trạng thái thành công</dd>
  </dl>

  <h4>Chế độ phản hồi đầy đủ</h4>
  <dl class="message-properties">
    <dt>payload <span class="property-type">object</span></dt>
    <dd>Đối tượng phản hồi công cụ đầy đủ, bao gồm các trường content và isError</dd>
  </dl>

  <h4>Chế độ tách đầu ra</h4>
  <p>Cổng đầu ra 1 (kết quả)：</p>
  <dl class="message-properties">
    <dt>payload <span class="property-type">any</span></dt>
    <dd>Dữ liệu kết quả thực thi công cụ</dd>
  </dl>
  
  <p>Cổng đầu ra 2 (siêu dữ liệu)：</p>
  <dl class="message-properties">
    <dt>payload <span class="property-type">object</span></dt>
    <dd>Siêu dữ liệu gọi: tên công cụ, thời gian phản hồi, trạng thái, v.v.</dd>
  </dl>

  <h3>Ví dụ sử dụng</h3>
  <p><strong>Gọi công cụ điều khiển LED</strong></p>
  <ol>
    <li>Chọn công cụ mục tiêu：<code>led_control</code></li>
    <li>Đặt nguồn đối số：<code>đối số cấu hình</code></li>
    <li>Cấu hình đối số công cụ：
      <pre>{
  "pin": 2,
  "state": true
}</pre>
    </li>
    <li>Chọn chế độ đầu ra：<code>chỉ kết quả</code></li>
    <li>Nhập bất kỳ tin nhắn nào để kích hoạt gọi</li>
  </ol>

  <p><strong>Gọi với đối số động</strong></p>
  <ol>
    <li>Đặt nguồn đối số：<code>msg.payload</code></li>
    <li>Tin nhắn đầu vào：
      <pre>{
  "payload": {
    "pin": 3,
    "state": false
  }
}</pre>
    </li>
    <li>Nút sẽ sử dụng đối số trong payload để gọi công cụ</li>
  </ol>

  <h3>Lưu ý</h3>
  <ul>
    <li>Đảm bảo công cụ mục tiêu đã được đăng ký trên máy chủ MCP</li>
    <li>Đối số công cụ phải tuân theo yêu cầu Schema của công cụ mục tiêu</li>
    <li>Sử dụng chế độ tách đầu ra có thể xử lý riêng kết quả và trạng thái</li>
    <li>Cơ chế thử lại có thể cải thiện độ tin cậy của việc gọi</li>
    <li>Đặt thời gian chờ hợp lý, tránh chờ đợi lâu</li>
    <li>Chế độ xử lý lỗi sẽ ảnh hưởng đến hành vi thực thi của luồng</li>
  </ul>
</script>

<style>
  .red-ui-help {
    font-size: 12px;
    color: #666;
    margin-top: 5px;
  }
  
  .red-ui-help h4 {
    margin: 10px 0 5px 0;
    font-size: 13px;
    font-weight: bold;
  }
  
  .red-ui-help pre {
    background: #f5f5f5;
    padding: 8px;
    margin: 5px 0;
    font-size: 11px;
    border-radius: 3px;
    overflow-x: auto;
  }
  
  .red-ui-help ul {
    margin: 5px 0;
    padding-left: 20px;
  }
  
  #args-valid {
    color: #5cb85c;
  }
  
  #args-error {
    color: #d9534f;
  }

  .output-labels {
    background: #f9f9f9;
    padding: 10px;
    border-radius: 4px;
    margin-top: 10px;
  }
</style>