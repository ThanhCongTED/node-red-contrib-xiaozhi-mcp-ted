<!--
Nút xử lý tin nhắn xiaozhi-message
Dùng để xử lý việc gửi, nhận và định dạng tin nhắn MCP
-->

<script type="text/javascript">
  RED.nodes.registerType('xiaozhi-message', {
    category: '小智MCP', // Giữ nguyên category nếu đây là tên nhóm
    color: '#DDA0DD',
    defaults: {
      name: { value: '' },
      xiaozhi: { value: '', type: 'xiaozhi-config', required: true },
      messageMode: { value: 'send' },
      messageType: { value: 'notification' },
      method: { value: '' },
      params: { value: '{}' },
      paramsSource: { value: 'configured' },
      outputFormat: { value: 'payload' },
      filterIncoming: { value: true },
      methodFilter: { value: '' },
      enableLogging: { value: true }
    },
    inputs: function() {
      return this.messageMode === 'receive' ? 0 : 1;
    },
    outputs: function() {
      return this.messageMode === 'bidirectional' ? 2 : 1;
    },
    outputLabels: function() {
      if (this.messageMode === 'bidirectional') {
        return ['Xác nhận gửi', 'Tin nhắn nhận'];
      }
      return this.messageMode === 'receive' ? 'Tin nhắn nhận' : 'Xác nhận gửi';
    },
    icon: 'font-awesome/fa-exchange',
    label: function() {
      if (this.name) return this.name;
      if (this.method) return `Tin nhắn: ${this.method}`;
      return 'Xử lý tin nhắn';
    },
    paletteLabel: 'Xử lý tin nhắn', // Nhãn trên thanh công cụ
    oneditprepare: function() {
      var node = this;
      
      // Khởi tạo trình chỉnh sửa tham số
      var paramsEditor = RED.editor.createEditor({
        id: 'node-input-params-editor',
        mode: 'ace/mode/json',
        value: node.params || '{}'
      });

      // Xử lý thay đổi chế độ tin nhắn
      $('#node-input-messageMode').on('change', function() {
        var mode = $(this).val();
        var sendOptions = $('#send-options');
        var receiveOptions = $('#receive-options');
        
        if (mode === 'send') {
          sendOptions.show();
          receiveOptions.hide();
        } else if (mode === 'receive') {
          sendOptions.hide();
          receiveOptions.show();
        } else {
          sendOptions.show();
          receiveOptions.show();
        }
      });

      // Xử lý thay đổi nguồn tham số
      $('#node-input-paramsSource').on('change', function() {
        var source = $(this).val();
        var paramsContainer = $('#params-editor-container');
        paramsContainer.toggle(source === 'configured');
      });

      // Xác thực tham số JSON
      var validateParams = function() {
        try {
          JSON.parse(paramsEditor.getValue());
          $('#params-error').hide();
          $('#params-valid').show();
          return true;
        } catch (e) {
          $('#params-error').text('Lỗi định dạng JSON: ' + e.message).show();
          $('#params-valid').hide();
          return false;
        }
      };

      paramsEditor.on('change', function() {
        setTimeout(validateParams, 500);
      });

      // Mẫu định nghĩa trước
      $('#method-template').on('change', function() {
        var template = $(this).val();
        var templates = {
          'ping': { method: 'ping', params: {} },
          'tools/list': { method: 'tools/list', params: {} },
          'tools/call': { method: 'tools/call', params: { name: 'tool_name', arguments: {} }}
        };
        if (template && templates[template]) {
          $('#node-input-method').val(templates[template].method);
          paramsEditor.setValue(JSON.stringify(templates[template].params, null, 2));
        }
      });

      // Kiểm tra gửi
      $('#test-send').on('click', function() {
        if (!node.id) {
          RED.notify('Vui lòng lưu cấu hình nút trước', 'warn');
          return;
        }
        var method = $('#node-input-method').val();
        var params = {};
        try {
          params = JSON.parse(paramsEditor.getValue());
        } catch (e) {
          RED.notify('Lỗi định dạng JSON tham số', 'error');
          return;
        }

        $.ajax({
          url: 'xiaozhi-message/' + node.id + '/test',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ method, params }),
          success: function(data) {
            RED.notify(data.success ? 'Gửi tin nhắn thành công' : 'Gửi thất bại: ' + data.error, 
                      data.success ? 'success' : 'error');
          },
          error: function() {
            RED.notify('Gửi thất bại', 'error');
          }
        });
      });

      // Khởi tạo
      setTimeout(function() {
        $('#node-input-messageMode').trigger('change');
        $('#node-input-paramsSource').trigger('change');
        validateParams();
      }, 100);
    },
    oneditsave: function() {
      var paramsEditor = RED.editor.getEditor('node-input-params-editor');
      if (paramsEditor) {
        this.params = paramsEditor.getValue();
      }
    },
    oneditcancel: function() {
      var paramsEditor = RED.editor.getEditor('node-input-params-editor');
      if (paramsEditor) {
        paramsEditor.destroy();
      }
    }
  });
</script>

<script type="text/html" data-template-name="xiaozhi-message">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Tên nút</label>
    <input type="text" id="node-input-name" placeholder="Tên nút (tùy chọn)">
  </div>

  <div class="form-row">
    <label for="node-input-xiaozhi"><i class="fa fa-plug"></i> Cấu hình Xiaozhi</label>
    <input type="text" id="node-input-xiaozhi">
  </div>

  <div class="form-row">
    <label for="node-input-messageMode"><i class="fa fa-exchange"></i> Chế độ tin nhắn</label>
    <select id="node-input-messageMode">
      <option value="send">Chỉ gửi</option>
      <option value="receive">Chỉ nhận</option>
      <option value="bidirectional">Xử lý hai chiều</option>
    </select>
  </div>

  <div id="send-options">
    <div class="form-row">
      <label for="node-input-messageType"><i class="fa fa-envelope"></i> Loại tin nhắn</label>
      <select id="node-input-messageType">
        <option value="notification">Thông báo</option>
        <option value="request">Yêu cầu</option>
        <option value="response">Phản hồi</option>
      </select>
    </div>

    <div class="form-row">
      <label for="node-input-method"><i class="fa fa-code"></i> Tên phương thức</label>
      <input type="text" id="node-input-method" placeholder="ping">
      <select id="method-template" style="width: 120px; margin-left: 10px;">
        <option value="">Mẫu...</option>
        <option value="ping">ping</option>
        <option value="tools/list">tools/list</option>
        <option value="tools/call">tools/call</option>
      </select>
    </div>

    <div class="form-row">
      <label for="node-input-paramsSource"><i class="fa fa-code"></i> Nguồn tham số</label>
      <select id="node-input-paramsSource">
        <option value="configured">Tham số cấu hình</option>
        <option value="msg">msg.payload</option>
        <option value="msg.params">msg.params</option>
        <option value="flow">Ngữ cảnh Flow</option>
        <option value="global">Ngữ cảnh Global</option>
      </select>
    </div>

    <div id="params-editor-container">
      <div class="form-row">
        <label for="node-input-params-editor">Tham số tin nhắn</label>
        <div style="height: 150px;" class="node-text-editor" id="node-input-params-editor"></div>
        <div id="params-valid" style="display:none; color: green;">
          <i class="fa fa-check"></i> Định dạng tham số chính xác
        </div>
        <div id="params-error" style="display:none; color: red;">
          <i class="fa fa-exclamation-triangle"></i> <span></span>
        </div>
      </div>
    </div>
  </div>

  <div id="receive-options" style="display:none;">
    <div class="form-row">
      <label>&nbsp;</label>
      <input type="checkbox" id="node-input-filterIncoming" style="width:auto;">
      <label for="node-input-filterIncoming" style="width:70%;">Bật lọc tin nhắn</label>
    </div>

    <div class="form-row">
      <label for="node-input-methodFilter"><i class="fa fa-filter"></i> Bộ lọc phương thức</label>
      <input type="text" id="node-input-methodFilter" placeholder="ping,tools/*">
    </div>
  </div>

  <div class="form-row">
    <label for="node-input-outputFormat"><i class="fa fa-share"></i> Định dạng đầu ra</label>
    <select id="node-input-outputFormat">
      <option value="payload">Trích xuất dữ liệu</option>
      <option value="full">Đối tượng đầy đủ</option>
      <option value="jsonrpc">Tin nhắn gốc</option>
    </select>
  </div>

  <div class="form-row">
    <label>&nbsp;</label>
    <input type="checkbox" id="node-input-enableLogging" style="width:auto;">
    <label for="node-input-enableLogging" style="width:70%;">Bật ghi nhật ký tin nhắn</label>
  </div>

  <div class="form-row">
    <label>&nbsp;</label>
    <button type="button" id="test-send" class="red-ui-button">
      <i class="fa fa-paper-plane"></i> Kiểm tra gửi
    </button>
  </div>
</script>

<script type="text/html" data-help-name="xiaozhi-message">
  <p>Nút xiaozhi-message dùng để xử lý việc gửi, nhận và định dạng tin nhắn MCP, hỗ trợ giao thức JSON-RPC 2.0.</p>

  <h3>Mô tả cấu hình</h3>
  <dl class="message-properties">
    <dt>Chế độ tin nhắn</dt>
    <dd>Chỉ gửi: Chỉ gửi tin nhắn đến máy chủ MCP</dd>
    <dd>Chỉ nhận: Chỉ nhận tin nhắn từ máy chủ MCP</dd>
    <dd>Xử lý hai chiều: Có thể gửi và nhận tin nhắn</dd>

    <dt>Loại tin nhắn</dt>
    <dd>Thông báo: Gửi một chiều, không cần phản hồi</dd>
    <dd>Yêu cầu: Cần phản hồi, bao gồm ID tin nhắn</dd>
    <dd>Phản hồi: Trả lời các yêu cầu khác</dd>

    <dt>Nguồn tham số</dt>
    <dd>Tham số cấu hình: Sử dụng tham số cố định trong trình chỉnh sửa bên dưới</dd>
    <dd>msg.payload: Sử dụng payload của tin nhắn đầu vào</dd>
    <dd>Khác: Sử dụng thuộc tính tin nhắn hoặc ngữ cảnh được chỉ định</dd>
  </dl>

  <h3>Các phương thức MCP được hỗ trợ</h3>
  <ul>
    <li>ping - Kiểm tra nhịp tim</li>
    <li>initialize - Khởi tạo kết nối</li>
    <li>tools/list - Lấy danh sách công cụ</li>
    <li>tools/call - Gọi công cụ</li>
    <li>Phương thức tùy chỉnh</li>
  </ul>

  <h3>Ví dụ sử dụng</h3>
  <p><strong>Gửi tin nhắn ping：</strong></p>
  <ol>
    <li>Chế độ tin nhắn：Chỉ gửi</li>
    <li>Loại tin nhắn：Thông báo</li>
    <li>Tên phương thức：ping</li>
    <li>Tham số：{}</li>
  </ol>

  <p><strong>Nhận lời gọi công cụ：</strong></p>
  <ol>
    <li>Chế độ tin nhắn：Chỉ nhận</li>
    <li>Bật lọc tin nhắn</li>
    <li>Bộ lọc phương thức：tools/*</li>
  </ol>
</script>